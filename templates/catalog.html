{% extends "layout.html" %}
{% block title %}Image Catalog - {{ super() }}{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 id="page-title">Image Catalog</h2>
                <div>
                    <label for="thumb-size-select" class="form-label">Thumbnail Size:</label>
                    <select id="thumb-size-select" class="form-select d-inline-block w-auto">
                        <option value="128" selected>Small</option>
                        <option value="192">Medium</option>
                        <option value="256">Large</option>
                    </select>
                    <button id="review-selected-btn" class="btn btn-secondary" disabled>Review Selected</button>
                    <button id="delete-selected-btn" class="btn btn-danger" disabled>Delete Selected</button>
                    <a href="/project" class="btn btn-primary">Go to Project</a>
                </div>
            </div>
            <div id="image-grid" class="grid noselect"></div>
            <div id="pagination-controls" class="d-flex justify-content-center mt-3"></div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script src="/static/utils.js"></script>
<script>
let currentPage = 1;
const pageSize = {{ page_size }};
let thumbSize = 192;
let pageBoxes = {};
let projectAssociations = {};

async function fetchProjectAssociations() {
    const response = await fetch('/api/catalog/project_associations');
    if (!response.ok) {
        console.error('Failed to fetch project associations');
        return {};
    }
    return await response.json();
}

function drawOverlayForTile(tile, name){
    const img = tile.querySelector("img.thumb");
    if (!img) return;
    let overlay = tile.querySelector("canvas.overlay");
    if (!overlay){
      overlay = document.createElement("canvas");
      overlay.className = "overlay";
      tile.appendChild(overlay);
    }
    const w = img.clientWidth || img.width;
    const h = img.clientHeight || img.height;
    overlay.width = w; overlay.height = h;
    const ctx = overlay.getContext("2d");
    ctx.imageSmoothingEnabled = false;
    ctx.clearRect(0,0,w,h);
    const boxData = (pageBoxes && pageBoxes[name]) ? pageBoxes[name] : null;
    if (!boxData) return;
    const boxes = boxData.boxes || [];
    const origW = boxData.w || 224;
    const origH = boxData.h || 224;
    if (!boxes.length) return;
    const f = (w / origW);
    ctx.save();
    ctx.lineWidth = Math.max(1, Math.round(1*f));
    ctx.font = `${Math.max(10, Math.round(10*f))}px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial`;
    const isNull = boxes.some(b => b.label === "__null__");
    if (isNull) {
      ctx.strokeStyle = "rgba(255, 50, 50, 0.8)";
      ctx.lineWidth = 2 * f;
      ctx.beginPath();
      ctx.moveTo(0, 0);
      ctx.lineTo(w, h);
      ctx.stroke();
      ctx.moveTo(w, 0);
      ctx.lineTo(0, h);
      ctx.stroke();
    }
    boxes.forEach(b => {
      if (b.label === "__null__") return;
      ctx.strokeStyle = colorFromString(b.label);
      const x = Math.min(b.x1,b.x2)*f, y = Math.min(b.y1,b.y2)*f;
      const bw = Math.abs(b.x2-b.x1)*f, bh = Math.abs(b.y2-b.y1)*f;
      ctx.strokeRect(x,y,bw,bh);
      if (b.label){
        const pad = 4*f;
        const tw = ctx.measureText(b.label).width + pad*2;
        const bhh = (14*f);
        ctx.fillStyle = "rgba(0,0,0,0.6)";
        ctx.fillRect(x, Math.max(0, y-bhh), tw, bhh);
        ctx.fillStyle = "#fff";
        ctx.fillText(b.label, x+pad, Math.max(10*f, y-4*f));
      }
    });
    ctx.restore();
}

async function fetchBoxesForPage(imgs){
    try{
      const res = await fetch("/api/catalog/annotations_bulk", {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ images: imgs })
      });
      if (!res.ok) throw new Error(`bulk ${res.status}`);
      const data = await res.json();
      return data.items || {};
    } catch(e){
      return {};
    }
}


async function fetchImages(page = 1) {
    const response = await fetch(`/api/catalog/images?page=${page}&page_size=${pageSize}`);
    if (!response.ok) {
        console.error('Failed to fetch images');
        return null;
    }
    return await response.json();
}

function renderImages(images) {
    const grid = document.getElementById('image-grid');
    grid.innerHTML = '';
    images.forEach(image => {
        const tile = document.createElement('div');
        tile.className = 'tile';

        const img = document.createElement('img');
        img.src = `/image/${encodeURIComponent(image)}`;
        img.className = 'thumb';
        img.alt = image;
        tile.appendChild(img);

        const editLink = document.createElement('a');
        editLink.href = `/annotate?image=${encodeURIComponent(image)}`;
        editLink.className = 'btn btn-sm btn-outline-light edit-btn';
        editLink.textContent = 'Edit';
        tile.appendChild(editLink);

        const projects = projectAssociations[image];
        if (projects && projects.length > 0) {
            const projectOverlay = document.createElement('div');
            projectOverlay.className = 'project-overlay';
            projectOverlay.textContent = projects.join(', ');
            tile.appendChild(projectOverlay);
        }

        grid.appendChild(tile);
    });
}

function renderPagination(total, page, page_size) {
    const paginationControls = document.getElementById('pagination-controls');
    paginationControls.innerHTML = '';
    const totalPages = Math.ceil(total / page_size);
    if (totalPages <= 1) return;

    const nav = document.createElement('nav');
    const ul = document.createElement('ul');
    ul.className = 'pagination';

    for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === page ? 'active' : ''}`;
        const a = document.createElement('a');
        a.className = 'page-link';
        a.href = '#';
        a.innerText = i;
        a.addEventListener('click', (e) => {
            e.preventDefault();
            currentPage = i;
            loadPage(currentPage);
        });
        li.appendChild(a);
        ul.appendChild(li);
    }
    nav.appendChild(ul);
    paginationControls.appendChild(nav);
}

async function loadPage(page) {
    const data = await fetchImages(page);
    if (data) {
        projectAssociations = await fetchProjectAssociations();
        renderImages(data.images);
        renderPagination(data.total, data.page, data.page_size);
        pageBoxes = await fetchBoxesForPage(data.images);
        const grid = document.getElementById('image-grid');
        Array.from(grid.children).forEach(tile => {
            const name = tile.querySelector('img')?.alt;
            if (name) {
                drawOverlayForTile(tile, name);
            }
        });
    }
}

document.addEventListener('DOMContentLoaded', () => {
    const thumbSizeSelect = document.getElementById('thumb-size-select');
    const grid = document.getElementById('image-grid');
    const reviewSelectedBtn = document.getElementById('review-selected-btn');
    const deleteSelectedBtn = document.getElementById('delete-selected-btn');

    thumbSizeSelect.addEventListener('change', (e) => {
        thumbSize = parseInt(e.target.value, 10);
        grid.style.gridTemplateColumns = `repeat(auto-fill, minmax(${thumbSize}px, 1fr))`;
    });
    thumbSize = parseInt(thumbSizeSelect.value, 10);
    grid.style.gridTemplateColumns = `repeat(auto-fill, minmax(${thumbSize}px, 1fr))`;

    grid.addEventListener('click', (e) => {
        if (e.target.classList.contains('edit-btn')) {
            return;
        }
        const tile = e.target.closest('.tile');
        if (tile) {
            tile.classList.toggle('selected');
            updateButtons();
        }
    });

    reviewSelectedBtn.addEventListener('click', () => {
        const selectedTiles = grid.querySelectorAll('.tile.selected');
        const selectedImages = Array.from(selectedTiles).map(tile => tile.querySelector('img').alt);
        if (selectedImages.length > 0) {
            sessionStorage.setItem('reviewImages', JSON.stringify(selectedImages));
            window.location.href = '/review';
        }
    });

    deleteSelectedBtn.addEventListener('click', async () => {
        const selectedTiles = grid.querySelectorAll('.tile.selected');
        const selectedImages = Array.from(selectedTiles).map(tile => tile.querySelector('img').alt);
        if (selectedImages.length === 0) {
            alert('No images selected for deletion.');
            return;
        }
        if (confirm(`Are you sure you want to permanently delete ${selectedImages.length} image(s)? This cannot be undone.`)) {
            const response = await fetch('/api/catalog/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ files: selectedImages })
            });
            const result = await response.json();
            if (result.errors && result.errors.length > 0) {
                alert(`Error deleting some images: ${JSON.stringify(result.errors)}`);
            }
            loadPage(currentPage);
        }
    });

    function updateButtons() {
        const selectedCount = grid.querySelectorAll('.tile.selected').length;
        reviewSelectedBtn.disabled = selectedCount === 0;
        deleteSelectedBtn.disabled = selectedCount === 0;
        reviewSelectedBtn.textContent = selectedCount > 0 ? `Review Selected (${selectedCount})` : 'Review Selected';
        deleteSelectedBtn.textContent = selectedCount > 0 ? `Delete Selected (${selectedCount})` : 'Delete Selected';
    }

    loadPage(currentPage);
});
</script>
{% endblock %}