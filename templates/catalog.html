{% extends "layout.html" %}
{% block title %}Image Catalog - {{ super() }}{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 id="page-title">Image Catalog</h2>
                <div>
                    <a href="/project" class="btn btn-primary">Go to Project</a>
                </div>
            </div>
            <div id="image-grid" class="row"></div>
            <div id="pagination-controls" class="d-flex justify-content-center mt-3"></div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script src="/static/utils.js"></script>
<script>
let currentPage = 1;
const pageSize = {{ page_size }};

async function fetchImages(page = 1) {
    const response = await fetch(`/api/catalog/images?page=${page}&page_size=${pageSize}`);
    if (!response.ok) {
        console.error('Failed to fetch images');
        return null;
    }
    return await response.json();
}

function renderImages(images) {
    const grid = document.getElementById('image-grid');
    grid.innerHTML = '';
    images.forEach(image => {
        const col = document.createElement('div');
        col.className = 'col-md-2 col-sm-4 col-6 mb-3';
        const card = document.createElement('div');
        card.className = 'card h-100';

        const imgLink = document.createElement('a');
        imgLink.href = `/annotate?image=${encodeURIComponent(image)}`;

        const img = document.createElement('img');
        img.src = `/image/${encodeURIComponent(image)}`;
        img.className = 'card-img-top';
        img.alt = image;

        imgLink.appendChild(img);
        card.appendChild(imgLink);
        col.appendChild(card);
        grid.appendChild(col);
    });
}

function renderPagination(total, page, page_size) {
    const paginationControls = document.getElementById('pagination-controls');
    paginationControls.innerHTML = '';
    const totalPages = Math.ceil(total / page_size);
    if (totalPages <= 1) return;

    const nav = document.createElement('nav');
    const ul = document.createElement('ul');
    ul.className = 'pagination';

    for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === page ? 'active' : ''}`;
        const a = document.createElement('a');
        a.className = 'page-link';
        a.href = '#';
        a.innerText = i;
        a.addEventListener('click', (e) => {
            e.preventDefault();
            currentPage = i;
            loadPage(currentPage);
        });
        li.appendChild(a);
        ul.appendChild(li);
    }
    nav.appendChild(ul);
    paginationControls.appendChild(nav);
}

async function loadPage(page) {
    const data = await fetchImages(page);
    if (data) {
        renderImages(data.images);
        renderPagination(data.total, data.page, data.page_size);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    loadPage(currentPage);
});
</script>
{% endblock %}