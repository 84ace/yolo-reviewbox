{% extends "layout.html" %}
{% block title %}Image Catalog - {{ super() }}{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 id="page-title">Image Catalog</h2>
                <div>
                    <label for="thumb-size-select" class="form-label">Thumbnail Size:</label>
                    <select id="thumb-size-select" class="form-select d-inline-block w-auto">
                        <option value="128" selected>Small</option>
                        <option value="192">Medium</option>
                        <option value="256">Large</option>
                    </select>
                    <button id="review-selected-btn" class="btn btn-secondary" disabled>Review Selected</button>
                    <button id="delete-selected-btn" class="btn btn-danger" disabled>Delete Selected</button>
                    <a href="/project" class="btn btn-primary">Go to Project</a>
                </div>
            </div>
            <div id="category-controls" class="d-flex justify-content-between align-items-center mb-3">
                <div class="btn-group" role="group" aria-label="Category filter">
                    <button type="button" class="btn btn-outline-primary category-btn active" data-category="">All Categories</button>
                    <button type="button" class="btn btn-outline-primary category-btn" data-category="TrapNode">TrapNode</button>
                    <button type="button" class="btn btn-outline-primary category-btn" data-category="TrailCam">TrailCam</button>
                    <button type="button" class="btn btn-outline-primary category-btn" data-category="CageNode">CageNode</button>
                </div>
                <div class="input-group" style="max-width: 300px;">
                    <label class="input-group-text" for="class-filter-select">Filter by Class</label>
                    <select id="class-filter-select" class="form-select">
                        <option value="">All Classes</option>
                    </select>
                </div>
                <div class="btn-group" role="group" aria-label="Move selected">
                    <button id="move-to-trapnode-btn" class="btn btn-outline-secondary" disabled>Move to TrapNode</button>
                    <button id="move-to-cagenode-btn" class="btn btn-outline-secondary" disabled>Move to CageNode</button>
                </div>
                <div class="input-group" style="max-width: 300px;">
                    <select id="class-select" class="form-select">
                        <option selected>Choose class...</option>
                    </select>
                    <button id="change-class-btn" class="btn btn-outline-secondary" type="button" disabled>Change Class</button>
                </div>
            </div>
            <div id="image-grid" class="grid noselect"></div>
            <div id="pagination-controls" class="d-flex justify-content-center mt-3"></div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script src="/static/utils.js"></script>
<script>
let currentPage = 1;
const pageSize = {{ page_size }};
let thumbSize = 192;
let pageBoxes = {};
let projectAssociations = {};
let currentCategory = "";
let currentClassFilter = "";

function saveState() {
    const state = {
        page: currentPage,
        thumbSize: thumbSize,
        category: currentCategory,
        classFilter: currentClassFilter
    };
    sessionStorage.setItem('catalogState', JSON.stringify(state));
}

function loadState() {
    const savedState = sessionStorage.getItem('catalogState');
    if (savedState) {
        const state = JSON.parse(savedState);
        currentPage = state.page || 1;
        thumbSize = state.thumbSize || 192;
        currentCategory = state.category || "";
        currentClassFilter = state.classFilter || "";
    }
}

async function fetchClasses() {
    const response = await fetch('/api/classes');
    if (!response.ok) {
        console.error('Failed to fetch classes');
        return [];
    }
    const data = await response.json();
    return data.classes || [];
}

async function populateClassFilter() {
    const classes = await fetchClasses();
    const changeSelect = document.getElementById('class-select');
    const filterSelect = document.getElementById('class-filter-select');

    classes.forEach(cls => {
        const option1 = document.createElement('option');
        option1.value = cls;
        option1.textContent = cls;
        changeSelect.appendChild(option1);

        const option2 = document.createElement('option');
        option2.value = cls;
        option2.textContent = cls;
        filterSelect.appendChild(option2);
    });
}

async function fetchProjectAssociations() {
    const response = await fetch('/api/catalog/project_associations');
    if (!response.ok) {
        console.error('Failed to fetch project associations');
        return {};
    }
    return await response.json();
}

function drawOverlayForTile(tile, name){
    const img = tile.querySelector("img.thumb");
    if (!img) return;
    let overlay = tile.querySelector("canvas.overlay");
    if (!overlay){
      overlay = document.createElement("canvas");
      overlay.className = "overlay";
      tile.appendChild(overlay);
    }
    const w = img.clientWidth || img.width;
    const h = img.clientHeight || img.height;
    overlay.width = w; overlay.height = h;
    const ctx = overlay.getContext("2d");
    ctx.imageSmoothingEnabled = false;
    ctx.clearRect(0,0,w,h);
    const boxData = (pageBoxes && pageBoxes[name]) ? pageBoxes[name] : null;
    if (!boxData) return;
    const boxes = boxData.boxes || [];
    const origW = boxData.w || 224;
    const origH = boxData.h || 224;
    if (!boxes.length) return;
    const f = (w / origW);
    ctx.save();
    ctx.lineWidth = Math.max(1, Math.round(1*f));
    ctx.font = `${Math.max(10, Math.round(10*f))}px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial`;
    const isNull = boxes.some(b => b.label === "__null__");
    if (isNull) {
      ctx.strokeStyle = "rgba(255, 50, 50, 0.8)";
      ctx.lineWidth = 2 * f;
      ctx.beginPath();
      ctx.moveTo(0, 0);
      ctx.lineTo(w, h);
      ctx.stroke();
      ctx.moveTo(w, 0);
      ctx.lineTo(0, h);
      ctx.stroke();
    }
    boxes.forEach(b => {
      if (b.label === "__null__") return;
      ctx.strokeStyle = colorFromString(b.label);
      const x = Math.min(b.x1,b.x2)*f, y = Math.min(b.y1,b.y2)*f;
      const bw = Math.abs(b.x2-b.x1)*f, bh = Math.abs(b.y2-b.y1)*f;
      ctx.strokeRect(x,y,bw,bh);
      if (b.label){
        const pad = 4*f;
        const tw = ctx.measureText(b.label).width + pad*2;
        const bhh = (14*f);
        ctx.fillStyle = "rgba(0,0,0,0.6)";
        ctx.fillRect(x, Math.max(0, y-bhh), tw, bhh);
        ctx.fillStyle = "#fff";
        ctx.fillText(b.label, x+pad, Math.max(10*f, y-4*f));
      }
    });
    ctx.restore();
}

async function fetchBoxesForPage(imgs){
    try{
      const res = await fetch("/api/catalog/annotations_bulk", {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ images: imgs })
      });
      if (!res.ok) throw new Error(`bulk ${res.status}`);
      const data = await res.json();
      return data.items || {};
    } catch(e){
      return {};
    }
}


async function fetchImages(page = 1) {
    let url = `/api/catalog/images?page=${page}&page_size=${pageSize}`;
    if (currentCategory) {
        url += `&category=${encodeURIComponent(currentCategory)}`;
    }
    if (currentClassFilter) {
        url += `&class_filter=${encodeURIComponent(currentClassFilter)}`;
    }
    const response = await fetch(url);
    if (!response.ok) {
        console.error('Failed to fetch images');
        return null;
    }
    return await response.json();
}

function renderImages(images) {
    const grid = document.getElementById('image-grid');
    grid.innerHTML = '';
    images.forEach(image => {
        const tile = document.createElement('div');
        tile.className = 'tile';

        const img = document.createElement('img');
        img.src = `/image/${encodeURIComponent(image)}`;
        img.className = 'thumb';
        img.alt = image;
        tile.appendChild(img);

        const editLink = document.createElement('a');
        editLink.href = `/annotate?image=${encodeURIComponent(image)}`;
        editLink.className = 'btn btn-sm btn-outline-light edit-btn';
        editLink.textContent = 'Edit';
        tile.appendChild(editLink);

        const projects = projectAssociations[image];
        if (projects && projects.length > 0) {
            const projectOverlay = document.createElement('div');
            projectOverlay.className = 'project-overlay';
            projectOverlay.textContent = projects.join(', ');
            tile.appendChild(projectOverlay);
        }

        grid.appendChild(tile);
    });
}

function renderPagination(total, page, page_size) {
    const paginationControls = document.getElementById('pagination-controls');
    paginationControls.innerHTML = '';
    const totalPages = Math.ceil(total / page_size);
    if (totalPages <= 1) return;

    const nav = document.createElement('nav');
    const ul = document.createElement('ul');
    ul.className = 'pagination';

    for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === page ? 'active' : ''}`;
        const a = document.createElement('a');
        a.className = 'page-link';
        a.href = '#';
        a.innerText = i;
        a.addEventListener('click', (e) => {
            e.preventDefault();
            currentPage = i;
            saveState();
            loadPage(currentPage);
        });
        li.appendChild(a);
        ul.appendChild(li);
    }
    nav.appendChild(ul);
    paginationControls.appendChild(nav);
}

async function loadPage(page) {
    const data = await fetchImages(page);
    if (data) {
        projectAssociations = await fetchProjectAssociations();
        renderImages(data.images);
        renderPagination(data.total, data.page, data.page_size);
        pageBoxes = await fetchBoxesForPage(data.images);
        const grid = document.getElementById('image-grid');
        Array.from(grid.children).forEach(tile => {
            const name = tile.querySelector('img')?.alt;
            if (name) {
                drawOverlayForTile(tile, name);
            }
        });
    }
}

document.addEventListener('DOMContentLoaded', () => {
    const thumbSizeSelect = document.getElementById('thumb-size-select');
    const grid = document.getElementById('image-grid');
    const reviewSelectedBtn = document.getElementById('review-selected-btn');
    const deleteSelectedBtn = document.getElementById('delete-selected-btn');
    const changeClassBtn = document.getElementById('change-class-btn');
    const classSelect = document.getElementById('class-select');
    const classFilterSelect = document.getElementById('class-filter-select');
    let lastClickedIndex = null;

    loadState();

    populateClassFilter().then(() => {
        if (currentClassFilter) {
            classFilterSelect.value = currentClassFilter;
        }
    });

    if (currentCategory) {
        document.querySelector('.category-btn.active').classList.remove('active');
        document.querySelector(`.category-btn[data-category="${currentCategory}"]`).classList.add('active');
    }

    thumbSizeSelect.value = thumbSize;

    classFilterSelect.addEventListener('change', () => {
        currentClassFilter = classFilterSelect.value;
        currentPage = 1;
        saveState();
        loadPage(currentPage);
    });

    changeClassBtn.addEventListener('click', async () => {
        const selectedTiles = grid.querySelectorAll('.tile.selected');
        const selectedImages = Array.from(selectedTiles).map(tile => tile.querySelector('img').alt);
        const newClass = classSelect.value;

        if (selectedImages.length === 0 || !newClass || newClass === 'Choose class...') {
            alert('Please select images and a class.');
            return;
        }

        const response = await fetch('/api/catalog/change_class', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ files: selectedImages, new_class: newClass })
        });

        if (response.ok) {
            loadPage(currentPage);
        } else {
            alert('Failed to change class.');
        }
    });

    thumbSizeSelect.addEventListener('change', (e) => {
        thumbSize = parseInt(e.target.value, 10);
        grid.style.gridTemplateColumns = `repeat(auto-fill, minmax(${thumbSize}px, 1fr))`;
        saveState();
    });
    thumbSize = parseInt(thumbSizeSelect.value, 10);
    grid.style.gridTemplateColumns = `repeat(auto-fill, minmax(${thumbSize}px, 1fr))`;

    grid.addEventListener('click', (e) => {
        if (e.target.classList.contains('edit-btn')) {
            return;
        }
        const tile = e.target.closest('.tile');
        if (tile) {
            const tiles = Array.from(grid.children);
            const currentIndex = tiles.indexOf(tile);

            if (e.shiftKey && lastClickedIndex !== null) {
                const start = Math.min(lastClickedIndex, currentIndex);
                const end = Math.max(lastClickedIndex, currentIndex);
                for (let i = start; i <= end; i++) {
                    tiles[i].classList.add('selected');
                }
            } else {
                tile.classList.toggle('selected');
            }

            lastClickedIndex = currentIndex;
            updateButtons();
        }
    });

    reviewSelectedBtn.addEventListener('click', () => {
        const selectedTiles = grid.querySelectorAll('.tile.selected');
        const selectedImages = Array.from(selectedTiles).map(tile => tile.querySelector('img').alt);
        if (selectedImages.length > 0) {
            sessionStorage.setItem('reviewImages', JSON.stringify(selectedImages));
            window.location.href = '/review';
        }
    });

    deleteSelectedBtn.addEventListener('click', async () => {
        const selectedTiles = grid.querySelectorAll('.tile.selected');
        const selectedImages = Array.from(selectedTiles).map(tile => tile.querySelector('img').alt);
        if (selectedImages.length === 0) {
            alert('No images selected for deletion.');
            return;
        }
        if (confirm(`Are you sure you want to permanently delete ${selectedImages.length} image(s)? This cannot be undone.`)) {
            const response = await fetch('/api/catalog/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ files: selectedImages })
            });
            const result = await response.json();
            if (result.errors && result.errors.length > 0) {
                alert(`Error deleting some images: ${JSON.stringify(result.errors)}`);
            }
            loadPage(currentPage);
        }
    });

    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelector('.category-btn.active').classList.remove('active');
            btn.classList.add('active');
            currentCategory = btn.dataset.category;
            currentPage = 1;
            saveState();
            loadPage(currentPage);
        });
    });

    async function moveSelected(newCategory) {
        const selectedTiles = grid.querySelectorAll('.tile.selected');
        const selectedImages = Array.from(selectedTiles).map(tile => tile.querySelector('img').alt);
        if (selectedImages.length === 0) return;

        const response = await fetch('/api/catalog/move_category', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ files: selectedImages, category: newCategory })
        });

        if (response.ok) {
            loadPage(currentPage);
        } else {
            alert(`Failed to move images to ${newCategory}.`);
        }
    }

    document.getElementById('move-to-trapnode-btn').addEventListener('click', () => moveSelected('TrapNode'));
    document.getElementById('move-to-cagenode-btn').addEventListener('click', () => moveSelected('CageNode'));

    function updateButtons() {
        const selectedCount = grid.querySelectorAll('.tile.selected').length;
        const enabled = selectedCount > 0;
        reviewSelectedBtn.disabled = !enabled;
        deleteSelectedBtn.disabled = !enabled;
        document.getElementById('move-to-trapnode-btn').disabled = !enabled;
        document.getElementById('move-to-cagenode-btn').disabled = !enabled;
        changeClassBtn.disabled = !enabled;
        reviewSelectedBtn.textContent = enabled ? `Review Selected (${selectedCount})` : 'Review Selected';
        deleteSelectedBtn.textContent = enabled ? `Delete Selected (${selectedCount})` : 'Delete Selected';
    }

    document.addEventListener('keydown', (e) => {
        if (e.key === 'a' && document.activeElement.tagName.toLowerCase() !== 'input') {
            e.preventDefault();
            const tiles = grid.querySelectorAll('.tile');
            const allSelected = grid.querySelectorAll('.tile.selected').length === tiles.length;
            tiles.forEach(tile => {
                tile.classList.toggle('selected', !allSelected);
            });
            updateButtons();
        }
    });

    loadPage(currentPage);
});
</script>
{% endblock %}